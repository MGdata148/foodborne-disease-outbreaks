/* DATA EXPLORATION */

--Missing values

SELECT <column_name>, COUNT(*)
FROM outbreaks
WHERE <column_name> IS NULL
GROUP BY <column_name>; --for every field

--Data quality issues

SELECT <column_name>, 
	COUNT(*)
FROM lifestyle_info
GROUP BY <column_name>; --for every categorical field

SELECT COUNT(*)
FROM outbreaks
WHERE illnesses = 0; --these records don't make sense for quantitative analysis

--Number of records (not null)

SELECT COUNT(*)
FROM outbreaks
WHERE illnesses <> 0

--Number of records (not null) per year

SELECT year,
	COUNT(*)
FROM outbreaks
WHERE illnesses <> 0
GROUP BY year
ORDER BY year ASC;

--Number of records (not null) per food category

SELECT f.food_category,
	COUNT(*)
FROM outbreaks AS o
INNER JOIN food_categories AS f
	ON o.food = f.food
WHERE o.illnesses <> 0
GROUP BY f.food_category
ORDER BY f.food_category ASC;

--Number of records (not null) per species category

SELECT s.species_category,
	COUNT(*)
FROM outbreaks AS o
INNER JOIN species_categories AS s
	ON o.species = s.species
WHERE o.illnesses <> 0
GROUP BY s.species_category
ORDER BY s.species_category ASC;

--Number of illnesses, hospitalizations and fatalities registered overall

SELECT SUM(illnesses) AS total_illnesses,
	SUM(hospitalizations) AS total_hospitalizations,
	SUM(fatalities) AS total_fatalities
FROM outbreaks;

/* Q1: HOW HAVE FOODBORNE DISEASE OUTBREAKS EVOLVED OVER TIME? */

--FBD statistics by month

SELECT sq.month,
	COUNT(*) AS number_of_records,
	SUM(sq.illnesses) AS total_illnesses,
	SUM(sq.hospitalizations) AS total_hospitalizations,
	SUM(sq.fatalities) AS total_fatalities
FROM (SELECT*,
	EXTRACT(MONTH FROM TO_DATE(month, 'Month')) AS month_number
	FROM outbreaks) AS sq --subquery enables correct months ordering
WHERE sq.illnesses <> 0
GROUP BY sq.month, sq.month_number
ORDER BY sq.month_number ASC;

--FBD statistics by year

SELECT year,
	COUNT(*) AS number_of_records,
	SUM(illnesses) AS total_illnesses,
	SUM(hospitalizations) AS total_hospitalizations,
	SUM(fatalities) AS total_fatalities
FROM outbreaks
WHERE illnesses <> 0
GROUP BY year
ORDER BY year ASC;

--Most common causes of FBD over the years

WITH species_counts AS (SELECT year,
				species,
				COUNT(*)
			FROM outbreaks
			WHERE illnesses <> 0
				AND species IS NOT NULL
			GROUP BY year, species), --first cte to count outbreaks per year and species
species_ranking AS (SELECT*,
			RANK() OVER(PARTITION BY year ORDER BY count DESC) AS rank
		FROM species_counts
		GROUP BY year, species, count) --second cte to rank by descending count

SELECT year,
	species
FROM species_ranking
WHERE rank = 1;

/* Q2: WHICH FOODS AND LOCATIONS POSE THE HIGHEST RISK FOR FOODBORNE DISEASE CONTAMINATION? */

--Top 3 most dangerous food categories

SELECT f.food_category,
	COUNT(*)
FROM outbreaks AS o
INNER JOIN food_categories AS f
	ON o.food = f.food
WHERE o.illnesses <> 0
GROUP BY f.food_category
ORDER BY count DESC
LIMIT 3;

--Meat types most frequently causing FBD

WITH meat_types AS (SELECT food,
			ingredient,
			CASE WHEN food ILIKE '%chicken%' OR ingredient ILIKE '%chicken%'
					OR food ILIKE '%duck%' OR ingredient ILIKE '%duck%'
					OR food ILIKE '%turkey%' OR ingredient ILIKE '%turkey%'THEN 'Poultry'
				WHEN food ILIKE '%beef%' OR ingredient ILIKE '%beef%' THEN 'Beef'
				WHEN food ILIKE '%pork%' OR ingredient ILIKE '%pork%' THEN 'Pork'
				ELSE 'Other' END AS meat_type
		FROM outbreaks
		WHERE illnesses <> 0)

SELECT meat_type,
	COUNT(*)
FROM meat_types
WHERE meat_type <> 'Other'
GROUP BY meat_type
ORDER BY count DESC;

--The most common locations and their FBD data

SELECT location,
	COUNT(*) AS report_count,
	SUM(illnesses) / COUNT(*) AS illnesses_per_report,
	ROUND((SUM(hospitalizations::DECIMAL) / SUM(illnesses::DECIMAL) * 100), 2) AS hospitalizations_percentage,
	ROUND((SUM(fatalities::DECIMAL) / SUM(illnesses::DECIMAL) * 100), 2) AS deaths_percentage
FROM outbreaks
WHERE illnesses <> 0
	AND location IS NOT NULL
	AND location <> 'Unknown'
GROUP BY location
ORDER BY report_count DESC;

/* Q3: WHICH PATHOGENES PRESENT THE GREATEST THREAT TO PUBLIC HEALTH? */

--Number of illnesses, hospitalizations and deaths by category

--Number of illnesses, hospitalizations and deaths by species

--Number of illnesses, hospitalizations and deaths by genus (if applicable)
