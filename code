/* DATA CLEANING */

--Missing values

SELECT <column_name>, COUNT(*)
FROM outbreaks
WHERE <column_name> IS NULL
GROUP BY <column_name>; --for every field

--Data quality issues

SELECT <column_name>, 
	COUNT(*)
FROM lifestyle_info
GROUP BY <column_name>; --for every categorical field

SELECT COUNT(*)
FROM outbreaks
WHERE illnesses = 0; --these records don't make sense for quantitative analysis

 /* DATA EXPLORATION */

--Number of records (not null)

SELECT COUNT(*)
FROM outbreaks
WHERE illnesses <> 0

--Number of records (not null) per year

SELECT year,
	COUNT(*)
FROM outbreaks
WHERE illnesses <> 0
GROUP BY year
ORDER BY year ASC;

--Number of records (not null) per food category

SELECT f.food_category,
	COUNT(*)
FROM outbreaks AS o
INNER JOIN food_categories AS f
	ON o.food = f.food
WHERE o.illnesses <> 0
GROUP BY f.food_category
ORDER BY f.food_category ASC;

--Number of records (not null) per species category

SELECT s.species_category,
	COUNT(*)
FROM outbreaks AS o
INNER JOIN species_categories AS s
	ON o.species = s.species
WHERE o.illnesses <> 0
GROUP BY s.species_category
ORDER BY s.species_category ASC;

--Number of illnesses, hospitalizations and fatalities registered overall

SELECT SUM(illnesses) AS total_illnesses,
	SUM(hospitalizations) AS total_hospitalizations,
	SUM(fatalities) AS total_fatalities
FROM outbreaks;

/* Q1: HOW HAVE FOODBORNE DISEASE OUTBREAKS EVOLVED OVER TIME? */

--FBD statistics by month

SELECT sq.month,
	COUNT(*) AS number_of_records,
	SUM(sq.illnesses) AS total_illnesses,
	SUM(sq.hospitalizations) AS total_hospitalizations,
	SUM(sq.fatalities) AS total_fatalities
FROM (SELECT*,
	EXTRACT(MONTH FROM TO_DATE(month, 'Month')) AS month_number
	FROM outbreaks) AS sq --subquery enables correct months ordering
WHERE sq.illnesses <> 0
GROUP BY sq.month, sq.month_number
ORDER BY sq.month_number ASC;

--FBD statistics by year

SELECT year,
	COUNT(*) AS number_of_records,
	SUM(illnesses) AS total_illnesses,
	SUM(hospitalizations) AS total_hospitalizations,
	SUM(fatalities) AS total_fatalities
FROM outbreaks
WHERE illnesses <> 0
GROUP BY year
ORDER BY year ASC;

--Most common causes of FBD over the years

WITH species_counts AS (SELECT year,
				species,
				COUNT(*)
			FROM outbreaks
			WHERE illnesses <> 0
				AND species IS NOT NULL
			GROUP BY year, species), --first cte to count outbreaks per year and species
species_ranking AS (SELECT*,
			RANK() OVER(PARTITION BY year ORDER BY count DESC) AS rank
		FROM species_counts
		GROUP BY year, species, count) --second cte to rank by descending count

SELECT year,
	species
FROM species_ranking
WHERE rank = 1;

/* Q2: WHICH FOODS AND LOCATIONS POSE THE HIGHEST RISK FOR FOODBORNE DISEASE CONTAMINATION? */

--Foods

--Locations

--Foods and locations

/* Q3: WHICH PATHOGENES PRESENT THE GREATEST THREAT TO PUBLIC HEALTH? */

--Number of illnesses, hospitalizations and deaths by category

--Number of illnesses, hospitalizations and deaths by species

--Number of illnesses, hospitalizations and deaths by genus (if applicable)
